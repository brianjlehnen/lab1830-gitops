apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "loki.fullname" . }}-config
  labels:
    {{- include "loki.labels" . | nindent 4 }}
data:
  local-config.yaml: |
    auth_enabled: false

    server:
      http_listen_port: {{ .Values.config.server.http_listen_port }}
      grpc_listen_port: {{ .Values.config.server.grpc_listen_port }}

    common:
      path_prefix: {{ .Values.config.common.path_prefix }}
      storage:
        filesystem:
          chunks_directory: {{ .Values.config.common.storage.filesystem.chunks_directory }}
          rules_directory: {{ .Values.config.common.storage.filesystem.rules_directory }}
      replication_factor: {{ .Values.config.common.replication_factor }}

    memberlist:
      join_members: []

    storage_config:
      tsdb_shipper:
        active_index_directory: /loki/tsdb-index
        cache_location: /loki/tsdb-cache
      filesystem:
        directory: /loki/chunks

    schema_config:
      configs:
        {{- range .Values.config.schema_config.configs }}
        - from: {{ .from }}
          store: {{ .store }}
          object_store: {{ .object_store }}
          schema: {{ .schema }}
          index:
            prefix: {{ .index.prefix }}
            period: {{ .index.period }}
        {{- end }}

    query_range:
      results_cache:
        cache:
          embedded_cache:
            enabled: true
            max_size_mb: 100

    compactor:
      working_directory: /loki/compactor

    limits_config:
      retention_period: 168h
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      # Removed enforce_metric_name - not valid in Loki v3

    table_manager:
      retention_deletes_enabled: true
      retention_period: 168h

    analytics:
      reporting_enabled: false

    ruler:
      enable_api: false