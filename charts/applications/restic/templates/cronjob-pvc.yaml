{{- if .Values.backup.pvc.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "restic.fullname" . }}-pvc-backup
  labels:
    {{- include "restic.labels" . | nindent 4 }}
    component: pvc-backup
spec:
  schedule: {{ .Values.schedule.pvc | quote }}
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            {{- if .Values.vault.enabled }}
            vault.hashicorp.com/agent-inject: "true"
            vault.hashicorp.com/role: {{ .Values.vault.role | quote }}
            vault.hashicorp.com/agent-inject-secret-restic-config: {{ .Values.vault.secretPath | quote }}
            vault.hashicorp.com/agent-inject-template-restic-config: |
              {{`{{- with secret `}}"{{ .Values.vault.secretPath }}"{{` -}}
              export RESTIC_REPOSITORY="{{ .Data.data.repository }}"
              export RESTIC_PASSWORD="{{ .Data.data.password }}"
              export AWS_ACCESS_KEY_ID="{{ .Data.data.aws_access_key }}"
              export AWS_SECRET_ACCESS_KEY="{{ .Data.data.aws_secret_key }}"
              {{- end }}`}}
            {{- end }}
        spec:
          serviceAccountName: {{ include "restic.serviceAccountName" . }}
          restartPolicy: OnFailure
          containers:
            - name: pvc-backup
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting PVC backup job at $(date)"
                  
                  {{- if .Values.vault.enabled }}
                  # Source Vault configuration
                  source /vault/secrets/restic-config
                  {{- else }}
                  # Use direct configuration for staging
                  export RESTIC_REPOSITORY="{{ .Values.restic.repository }}"
                  export RESTIC_PASSWORD="{{ .Values.restic.password }}"
                  {{- end }}
                  
                  # Initialize repository
                  restic init || echo "Repository exists"
                  
                  # Backup PVC data
                  echo "Backing up PVC data..."
                  restic backup /backup-data --tag pvc-backup --tag $(date +%Y%m%d)
                  
                  # Cleanup old snapshots (keep last 7 days)
                  echo "Cleaning up old snapshots..."
                  restic forget --keep-daily 7 --prune
                  
                  echo "PVC backup completed at $(date)"
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
              volumeMounts:
                - name: backup-data
                  mountPath: /backup-data
                  readOnly: true
                {{- if .Values.vault.enabled }}
                - name: vault-secrets
                  mountPath: /vault/secrets
                  readOnly: true
                {{- end }}
          volumes:
            - name: backup-data
              emptyDir: {}
            {{- if .Values.vault.enabled }}
            - name: vault-secrets
              emptyDir:
                medium: Memory
            {{- end }}
{{- end }}